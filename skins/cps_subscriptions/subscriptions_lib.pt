<!-- CPSSubscriptions : zpt's macro lib -->
<!-- $Id$ -->

<!-- ###### Checkboxes wixthin a table used to configure notifications base on roles -->
<metal:block define-macro="display_subscriptions_table">
  <script type="text/javascript" tal:content="structure string:<!--
      var absolute_url = '${here/absolute_url}'
      -->">
  </script>
  <script type="text/javascript">
      <!--
      function open_subscribers_window() {
        selector_window = window.open(absolute_url + '/folder_notifications_all_subscribers_view', 'popup_select', 'toolbar=0,scrollbars=1,location=0,statusbar=0,' +
        'menubar=0,resizable=0,dependent=1,width=500,height=500');
        if (! selector_window.opener)
          selector_window.opener = window
      }
      -->
  </script>
  <tal:block define="context_lcs here/getLocalRolesFromContext">
    <form action="." name="form" tal:attributes="action here/absolute_url">
	  <table border="0" cellpadding="0" cellspacing="0" width="100%" class="FormLayout">
	    <tr>
	      <td>
            <i>
              <span i18n:translate="">
                Notification type
              </span>
            </i>
	      </td>
          <td tal:repeat="role python:context_lcs.keys()">
            <i>
            <span i18n:translate="">
                <span tal:replace="context_lcs/?role" />
            </span>
            </i>
          </td>
	      <td>
            <i>
             <span i18n:translate="label_other">
               Others
             </span>
            </i>
          </td>
	    </tr>
        <tr>
          <td>&nbsp;</td>
        </tr>
        <br />
        <tal:block define="events here/getEventTypesFromContext">
	       <tr tal:repeat="event_key python:events.keys()"
               tal:attributes="class python:test(repeat['event_key'].odd(), 'even','odd')">
	         <td>
               <strong>
                 <span i18n:translate="">
                   <span tal:replace="events/?event_key" />
                 </span>
               </strong>
             </td>
             <tal:block repeat="role python:context_lcs.keys()">
  	           <td align="center">
                 <input type="checkbox" name="role_event:list"
                        tal:attributes="value string:${role}:${event_key};
                                        checked python:here.isRoleSubscribedToEvent(event_key, role)" />
               </td>
             </tal:block>
	         <td align="center">
               <a href="."
                  tal:attributes="href string:${here/absolute_url}/folder_explicit_notifications_form?event_key=${event_key}">
                  <span i18n:translate="label_notifications_add">
                    Choose
                  </span>
               </a>
             </td>
	       </tr>
        </tal:block>
	  </table>
      <br />
      <hr />
      <br />
      <tal:block define="subscription_folder python:getattr(here,
      here.portal_subscriptions.getSubscriptionContainerId(), 0)">
        <table border="0" align="center" width="100%">
        <tr>
          <td align="center">
            <span i18n:translate="label_notifications_local_only">
              Notify local only
            </span>
          </td>
          <td align="left">
            <input type="checkbox" name="notify_local_only"
                   tal:attributes="checked python:subscription_folder and
      subscription_folder.isNotificationLocalOnly() or 0"
                   />
          </td>
        </tr>
        <tr>
          <td align="center">
            <span i18n:translate="label_notifications_no_local">
              Notify no local
            </span>
          </td>
          <td align="left">
            <input type="checkbox" name="notify_no_local"
                   tal:attributes="checked python:subscription_folder and
      subscription_folder.isNotificationNoLocal() or 0"
                   />
          </td>
        </tr>
        </table>
      </tal:block>
      <br />
      <hr />
      <a href="."
         tal:attributes="href string:javascript:open_subscribers_window()">
        <span i18n:translate="label_see_all_subscribers">
          See all subscribers
        </span>
      </a>
      <br />
      <br />
      <input type="submit" name="folder_notifications_edit:method"
             value="button_change" class="standAlone"
                   i18n:attributes="value" />
    </form>
  </tal:block>
</metal:block>

<!-- ###### Explicit/black emails for a given event -->
<metal:block define-macro="display_explicit_recipients_management">
<tal:block define="subtool here/portal_subscriptions;
                   event_key request/event_key|nothing;
                   event_id string:subscription__${event_key};
                   subscription_container python:getattr(here,
                   subtool.getSubscriptionContainerId(), None);
                   event python:getattr(subscription_container, event_id, None);
                   event_explicit_recipients_rules
    python:event and
    event.getRecipientsRules(recipients_rule_type='Explicit Recipients Rule') or [];
                   event_explicit_recipients_rule
                   python:event_explicit_recipients_rules != [] and
                   event_explicit_recipients_rules[0] or nothing;
                   explicit_emails python:event_explicit_recipients_rule and
                   event_explicit_recipients_rule.getEmails() or [];
                   black_list python:event and
                   event.getRecipientEmailsBlackList() or [];
                   ">
  <br />
  <!-- EMAILS -->
  <form action="." name="form" tal:attributes="action here/absolute_url">
  <div class="document">
    <div class="row">
      <div class="label">
        <span i18n:translate="label_emails">
          Explicit E-Mails
        </span>
      </div>
      <div class="row">
        <textarea cols="40" rows="10" name="explicit_emails:lines" wrap="soft" tal:content="python:'\n'.join(explicit_emails)"></textarea>
      </div>
    </div>
  </div>
  <!-- END EMAILS -->
  <!-- BLACK LIST -->
  <div class="document">
    <div class="row">
      <div class="label">
        <span i18n:translate="label_black_list">
          E-Mails Black list
        </span>
      </div>
      <div class="row">
        <textarea cols="40" rows="10" name="black_list:lines" wrap="soft" tal:content="python:'\n'.join(black_list)"></textarea>
      </div>
    </div>
  </div>
  <!-- END BLACK LIST -->
  <input type="hidden" name="event_id" tal:attributes="value event_id" />
  <input type="submit" class="standAlone" value="button_change"
         name="folder_explicit_notifications_edit:method"
         i18n:attributes="value" />
  <input type="button" class="standAlone" value="button_back"
         onclick="javascript:history.back()" i18n:attributes="value" />
</form>
</tal:block>
</metal:block>

<metal:block define-macro="display_all_notifications_subscribers">
<tal:block define="recipients here/getAllRecipientsFor">
  <br />
  <table border="0" width="80%" align="center" cellpadding="5"
  cellspacing="1">
    <tr>
      <td align="left">
        <strong>
          <span i18n:translate="label_subscriptions_email">
            E-Mails
          </span>
        </strong>
      </td>
      <td align="left">
        <strong>
          <span i18n:translate="label_subcriptions_fullname">
            Full Name
          </span>
        </strong>
      </td>
    </tr>
    <tr tal:repeat="recipient_mail python:recipients.keys()"
        tal:attributes="class python:test(repeat['recipient_mail'].even(),
    'even','odd')">
      <tal:block condition="recipient_mail">
        <td align="left">
          <a href="." tal:attributes="href string:mailto:${recipient_mail}">
            <span tal:replace="recipient_mail" />
          </a>
        </td>
        <td align="center">
          <span tal:replace="python:recipients[recipient_mail]" />
        </td>
      </tal:block>
    </tr>
    <tr>
      <td colspan="2" align="right">
        <input type="button" class="standAlone" value="button_close"
               onclick="javascript:window.close()"
               i18n:attributes="value" />
     </td>
   </tr>
</tal:block>
</metal:block>
